<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collibra Asset Summary</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for a clean, modern look */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Simple spinner animation */
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-2xl mx-auto bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 space-y-6">
        <!-- Header Section -->
        <div class="text-center">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">Your Assets so far in August</h1>
            <p class="text-gray-500 dark:text-gray-400 mt-1">How Many and What Kinds of Assets Added by Your Data Nerds</p>
        </div>

        <!-- Authentication Form -->
        <div id="auth-form" class="space-y-4">
            <div>
                <label for="username" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Username</label>
                <input type="text" id="username" value="USERNAME" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="Enter your username">
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
                <input type="password" id="password" value="PASSWORD" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="Enter your password">
            </div>
            <button id="fetch-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-800">
                Fetch Asset Summary
            </button>
        </div>

        <!-- Status/Loading Section -->
        <div id="status-container" class="hidden text-center p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
            <div class="flex items-center justify-center">
                <div class="spinner w-6 h-6 border-4 border-gray-200 dark:border-gray-600 rounded-full"></div>
                <p id="status-text" class="ml-3 font-medium text-gray-600 dark:text-gray-300">Initializing...</p>
            </div>
        </div>

        <!-- Error Display -->
        <div id="error-box" class="hidden p-4 bg-red-100 dark:bg-red-900/50 border-l-4 border-red-500 text-red-700 dark:text-red-300 rounded-r-lg">
            <p class="font-bold">An Error Occurred</p>
            <p id="error-message"></p>
        </div>

        <!-- Results Section -->
        <div id="results-container" class="hidden space-y-4">
            <div class="text-center p-4 bg-green-50 dark:bg-green-900/50 rounded-lg">
                 <h2 class="text-xl font-bold text-green-800 dark:text-green-200">Fetch Complete!</h2>
                 <p class="text-gray-600 dark:text-gray-300">Total assets found: <span id="total-assets" class="font-bold">0</span></p>
            </div>
            <div>
                <h3 class="text-lg font-semibold mb-2 text-center">Summary by Asset Type</h3>
                <div class="overflow-x-auto rounded-lg border border-gray-200 dark:border-gray-700">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Asset Type</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Count</th>
                            </tr>
                        </thead>
                        <tbody id="summary-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Rows will be injected here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Element References ---
        const fetchBtn = document.getElementById('fetch-btn');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const statusContainer = document.getElementById('status-container');
        const statusText = document.getElementById('status-text');
        const errorBox = document.getElementById('error-box');
        const errorMessage = document.getElementById('error-message');
        const resultsContainer = document.getElementById('results-container');
        const totalAssetsEl = document.getElementById('total-assets');
        const summaryTableBody = document.getElementById('summary-table-body');

        // --- Event Listener ---
        fetchBtn.addEventListener('click', handleFetchClick);

        async function handleFetchClick() {
            const username = usernameInput.value;
            const password = passwordInput.value;

            if (!username || !password) {
                showError('Username and Password are required.');
                return;
            }

            // --- Reset UI State ---
            fetchBtn.disabled = true;
            fetchBtn.textContent = 'Fetching...';
            errorBox.classList.add('hidden');
            resultsContainer.classList.add('hidden');
            statusContainer.classList.remove('hidden');
            statusText.textContent = 'Preparing to fetch assets...';

            try {
                // --- Start the main fetch and process logic ---
                const allAssets = await fetchAllAssets(username, password);

                // --- Process and Display Results ---
                if (allAssets) {
                    const countsByType = aggregateCounts(allAssets);
                    displayResults(allAssets.length, countsByType);
                }
            } catch (error) {
                showError(error.message);
            } finally {
                // --- Final UI State ---
                fetchBtn.disabled = false;
                fetchBtn.textContent = 'Fetch Asset Summary';
                statusContainer.classList.add('hidden');
            }
        }

        /**
         * Fetches all paginated assets from the GraphQL API.
         * Updates the UI with progress.
         */
        async function fetchAllAssets(username, password) {
            const endpoint = 'https://192.168.1.88:5404/graphql/knowledgeGraph/v1';
            const limit = 1000;
            let offset = 0;
            const allAssets = [];
            const startDate = "2025-08-01T00:00:00.000Z";
            
            // In browser, use btoa() to encode credentials, which is equivalent to Node.js's Buffer
            const encodedCredentials = btoa(`${username}:${password}`);

            while (true) {
                const query = `
                    query Assets($limit: Int, $offset: Int, $startDate: DateTime) {
                        assets(limit: $limit, offset: $offset, where: { createdOn: { gte: $startDate } }) {
                            type { name }
                        }
                    }
                `;
                const variables = { limit, offset, startDate };

                statusText.textContent = `Fetching page... Total found: ${allAssets.length}`;
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Basic ${encodedCredentials}`,
                    },
                    body: JSON.stringify({ query, variables }),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API request failed with status ${response.status}: ${errorText}`);
                }

                const jsonResponse = await response.json();
                if (jsonResponse.errors) {
                    throw new Error(`GraphQL error: ${JSON.stringify(jsonResponse.errors)}`);
                }

                const fetchedAssets = jsonResponse.data.assets;
                if (!fetchedAssets || fetchedAssets.length === 0) {
                    break; // Exit loop when no more assets are returned
                }

                allAssets.push(...fetchedAssets);
                offset += limit;
            }
            return allAssets;
        }

        /**
         * Aggregates the total count for each asset type.
         */
        function aggregateCounts(assets) {
            return assets.reduce((accumulator, asset) => {
                const typeName = asset.type?.name || 'Unknown Type';
                accumulator[typeName] = (accumulator[typeName] || 0) + 1;
                return accumulator;
            }, {});
        }

        /**
         * Renders the final results into the DOM.
         */
        function displayResults(totalCount, countsByType) {
            totalAssetsEl.textContent = totalCount;
            summaryTableBody.innerHTML = ''; // Clear previous results

            const sortedTypes = Object.keys(countsByType).sort();

            if (sortedTypes.length === 0) {
                 summaryTableBody.innerHTML = '<tr><td colspan="2" class="text-center px-6 py-4 text-gray-500">No assets found for the specified criteria.</td></tr>';
            } else {
                for (const type of sortedTypes) {
                    const count = countsByType[type];
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${type}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300 text-right font-mono">${count.toLocaleString()}</td>
                    `;
                    summaryTableBody.appendChild(row);
                }
            }

            resultsContainer.classList.remove('hidden');
        }

        /**
         * Displays an error message in the UI.
         */
        function showError(message) {
            errorMessage.textContent = message;
            errorBox.classList.remove('hidden');
        }

    </script>
</body>
</html>
